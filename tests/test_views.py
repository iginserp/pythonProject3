import os
from unittest.mock import patch

import pytest

from config import STOCKS_CURRENCIES_PATH
from src.utils import get_converted_date, load_json_file
from src.views import get_currency_rates, get_stock_prices

date_obj = get_converted_date("2021-10-16 16:00:00")
start_date = date_obj.strftime("%Y-%m-%d")
end_date = date_obj.strftime("%Y-%m-%d")

response_request = {
    "success": True,
    "timeseries": True,
    "start_date": "2021-10-16",
    "end_date": "2021-10-16",
    "base": "RUB",
    "rates": {
        "2021-10-16": {
            "AED": 0.051744,
            "AFN": 1.25871,
            "ALL": 1.47641,
            "AMD": 6.739673,
            "ANG": 0.025291,
            "AOA": 8.419978,
            "ARS": 1.396743,
            "AUD": 0.018991,
            "AWG": 0.025364,
            "AZN": 0.024004,
            "BAM": 0.023737,
            "BBD": 0.028448,
            "BDT": 1.205706,
            "BGN": 0.023761,
            "BHD": 0.00531,
            "BIF": 28.132425,
            "BMD": 0.014087,
            "BND": 0.018993,
            "BOB": 0.097358,
            "BRL": 0.076913,
            "BSD": 0.014089,
            "BTC": 2.31408e-07,
            "BTN": 1.056086,
            "BWP": 0.157777,
            "BYN": 0.034612,
            "BYR": 276.111934,
            "BZD": 0.028401,
            "CAD": 0.017436,
            "CDF": 28.329653,
            "CHF": 0.013008,
            "CLF": 0.000421,
            "CLP": 11.604455,
            "CNY": 0.090663,
            "COP": 53.012223,
            "CRC": 8.850273,
            "CUC": 0.014087,
            "CUP": 0.373315,
            "CVE": 1.344783,
            "CZK": 0.308257,
            "DJF": 2.503608,
            "DKK": 0.090367,
            "DOP": 0.795518,
            "DZD": 1.932939,
            "EGP": 0.221458,
            "ERN": 0.211328,
            "ETB": 0.65718,
            "EUR": 0.012145,
            "FJD": 0.029669,
            "FKP": 0.010329,
            "GBP": 0.010249,
            "GEL": 0.044164,
            "GGP": 0.010329,
            "GHS": 0.08544,
            "GIP": 0.010329,
            "GMD": 0.732547,
            "GNF": 136.647238,
            "GTQ": 0.109021,
            "GYD": 2.945024,
            "HKD": 0.109572,
            "HNL": 0.341266,
            "HRK": 0.091193,
            "HTG": 1.401956,
            "HUF": 4.372501,
            "IDR": 198.130739,
            "ILS": 0.045377,
            "IMP": 0.010329,
            "INR": 1.057044,
            "IQD": 20.567522,
            "IRR": 594.485904,
            "ISK": 1.814314,
            "JEP": 0.010329,
            "JMD": 2.117862,
            "JOD": 0.009988,
            "JPY": 1.611317,
            "KES": 1.562996,
            "KGS": 1.19466,
            "KHR": 57.476367,
            "KMF": 5.982196,
            "KPW": 12.678605,
            "KRW": 16.662375,
            "KWD": 0.004251,
            "KYD": 0.011741,
            "KZT": 6.004734,
            "LAK": 142.690708,
            "LBP": 21.468279,
            "LKR": 2.846049,
            "LRD": 2.330756,
            "LSL": 0.20723,
            "LTL": 0.041596,
            "LVL": 0.008521,
            "LYD": 0.064103,
            "MAD": 0.127576,
            "MDL": 0.243767,
            "MGA": 55.574575,
            "MKD": 0.747785,
            "MMK": 26.981117,
            "MNT": 40.161952,
            "MOP": 0.112896,
            "MRO": 5.029179,
            "MUR": 0.606527,
            "MVR": 0.217655,
            "MWK": 11.516456,
            "MXN": 0.286531,
            "MYR": 0.058576,
            "MZN": 0.8992,
            "NAD": 0.207155,
            "NGN": 5.788072,
            "NIO": 0.495175,
            "NOK": 0.118482,
            "NPR": 1.689722,
            "NZD": 0.019958,
            "OMR": 0.005424,
            "PAB": 0.014089,
            "PEN": 0.055413,
            "PGK": 0.049734,
            "PHP": 0.714374,
            "PKR": 2.411805,
            "PLN": 0.055489,
            "PYG": 97.214145,
            "QAR": 0.051293,
            "RON": 0.060109,
            "RSD": 1.427,
            "RUB": 1,
            "RWF": 14.016907,
            "SAR": 0.052836,
            "SBD": 0.113471,
            "SCR": 0.18962,
            "SDG": 6.219614,
            "SEK": 0.121472,
            "SGD": 0.018995,
            "SHP": 0.019404,
            "SLL": 149.396283,
            "SOS": 8.227013,
            "SRD": 0.300617,
            "STD": 291.57957,
            "SVC": 0.123285,
            "SYP": 17.707397,
            "SZL": 0.207155,
            "THB": 0.470595,
            "TJS": 0.159294,
            "TMT": 0.049165,
            "TND": 0.039776,
            "TOP": 0.031733,
            "TRY": 0.130567,
            "TTD": 0.095787,
            "TWD": 0.393927,
            "TZS": 32.471332,
            "UAH": 0.371751,
            "UGX": 50.864946,
            "USD": 0.014087,
            "UYU": 0.616977,
            "UZS": 150.805018,
            "VEF": 3012299809.101443,
            "VND": 320.634983,
            "VUV": 1.581958,
            "WST": 0.036303,
            "XAF": 7.960246,
            "XAG": 0.000604,
            "XAU": 7.96978e-06,
            "XCD": 0.038072,
            "XDR": 0.009976,
            "XOF": 7.945266,
            "XPF": 1.455575,
            "YER": 3.525363,
            "ZAR": 0.204373,
            "ZMK": 126.803048,
            "ZMW": 0.242135,
            "ZWL": 4.536119,
        }
    },
}


@patch("requests.get")
def test_get_currency_rates(mock_get):
    mock_get.return_value.json.return_value = response_request
    assert get_currency_rates(load_json_file(STOCKS_CURRENCIES_PATH)["user_currencies"], date_obj) == [
        {"currency": "USD", "rate": 70.99},
        {"currency": "EUR", "rate": 82.34},
        {"currency": "CHF", "rate": 76.88},
        {"currency": "GBP", "rate": 97.57},
        {"currency": "JPY", "rate": 0.62},
        {"currency": "CAD", "rate": 57.35},
        {"currency": "CNY", "rate": 11.03},
    ]
    mock_get.assert_called_once_with(
        f"https://api.apilayer.com/exchangerates_data/timeseries?start_date={start_date}&end_date={end_date}&base=RUB",
        headers={"apikey": os.getenv("APILAYER_KEY")},
        data=[],
    )


def test_get_currency_rates_():
    with pytest.raises(KeyError):
        assert get_currency_rates(load_json_file(STOCKS_CURRENCIES_PATH)["user_currencies"],
                                  get_converted_date("2035-11-11 16:00:00"))


def test_get_stock_prices():
    assert get_stock_prices(load_json_file(STOCKS_CURRENCIES_PATH)["user_stocks"], date_obj) == [
        {"AAPL": 144.68},
        {"AMZN": 172.34},
        {"GOOGL": 142.78},
        {"MSFT": 301.21},
        {"TSLA": 290.04},
    ]


def test_get_stock_prices_():
    with pytest.raises(IndexError):
        assert get_stock_prices(load_json_file(STOCKS_CURRENCIES_PATH)["user_stocks"],
                                get_converted_date("2035-11-11 16:00:00"))
